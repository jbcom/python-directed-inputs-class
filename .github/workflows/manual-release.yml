name: Manual Release to PyPI

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.1.0)'
        required: true
        type: string
      create_github_release:
        description: 'Create GitHub release if not exists'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.1.0)"
            exit 1
          fi

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: v${{ inputs.version }}
          # Use default GITHUB_TOKEN for checkout

      - name: Verify version tag exists
        run: |
          if ! git tag | grep -q "^v${{ inputs.version }}$"; then
            echo "Error: Tag v${{ inputs.version }} does not exist"
            exit 1
          fi
          echo "Tag v${{ inputs.version }} found"

      - name: Verify version in code
        run: |
          CODE_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)
          if [ "$CODE_VERSION" != "${{ inputs.version }}" ]; then
            echo "Error: Version in pyproject.toml ($CODE_VERSION) does not match tag (${{ inputs.version }})"
            exit 1
          fi
          echo "Version verified: $CODE_VERSION"

      - uses: hynek/setup-cached-uv@v2

      - name: Build package
        run: |
          uv build
          echo "Built packages:"
          ls -lh dist/

      - name: Check if version exists on PyPI
        id: pypi_check
        run: |
          if curl -s "https://pypi.org/pypi/directed-inputs-class/${{ inputs.version }}/json" | grep -q "\"version\":"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${{ inputs.version }} already exists on PyPI"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${{ inputs.version }} not found on PyPI"
          fi

      - name: Publish to PyPI
        if: steps.pypi_check.outputs.exists == 'false'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          skip-existing: true

      - name: Skip PyPI publish (already exists)
        if: steps.pypi_check.outputs.exists == 'true'
        run: |
          echo "âš ï¸ Version ${{ inputs.version }} already exists on PyPI, skipping publish"

      - name: Create GitHub Release
        if: inputs.create_github_release
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          # Check if release already exists
          if gh release view "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Release v${{ inputs.version }} already exists, updating artifacts"
            gh release upload "v${{ inputs.version }}" dist/* --clobber
          else
            echo "Creating new release v${{ inputs.version }}"
            # Extract changelog for this version
            CHANGELOG_ENTRY=$(sed -n "/## v${{ inputs.version }}/,/## v/p" CHANGELOG.md | sed '$ d' | tail -n +2)
            
            if [ -z "$CHANGELOG_ENTRY" ]; then
              CHANGELOG_ENTRY="Release v${{ inputs.version }}"
            fi
            
            echo "$CHANGELOG_ENTRY" | gh release create "v${{ inputs.version }}" \
              --title "v${{ inputs.version }}" \
              --notes-file - \
              dist/*
          fi

      - name: Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.pypi_check.outputs.exists }}" == "true" ]; then
            echo "**PyPI:** âš ï¸ Already published" >> $GITHUB_STEP_SUMMARY
          else
            echo "**PyPI:** âœ… Published successfully" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ inputs.create_github_release }}" == "true" ]; then
            echo "**GitHub Release:** âœ… Created/Updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "**GitHub Release:** â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View on PyPI: https://pypi.org/project/directed-inputs-class/${{ inputs.version }}/" >> $GITHUB_STEP_SUMMARY
